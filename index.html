<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>

<body>
    <!-- 查询教室是否可用 -->
    <div id="classroom">

        <div id="classroom">
            <div style="text-align:center;">
                <h1>查询哪些教室可用V0.6</h1>
            </div>
            <hr>
            <el-form label-width="100px">
                <el-form-item label="第几周">
                    <el-input v-model="week"></el-input>
                </el-form-item>
                <el-form-item label="教学楼">
                    <el-input v-model="building_name"></el-input>
                </el-form-item>
                <el-form-item label="星期几">
                    <el-input v-model="xqj"></el-input>
                </el-form-item>
                <el-form-item label="开始节次">
                    <el-input v-model="start"></el-input>
                </el-form-item>
                <el-form-item label="结束节次">
                    <el-input v-model="end"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" @click="find_available_classroom()">查询可用教室</el-button>
                </el-form-item>
            </el-form>

            <!-- 可用教室列表 -->
            <el-card v-if="available.length > 0" style="width:80%;margin:0 auto;">
                <div slot="header" style="font-weight: bold;">可用教室列表：</div>
                <div>
                    <span v-for="room in available" :key="room"> {{ room }} </span>
                </div>
            </el-card>
        </div>



    </div>
    <!-- 开发环境版本，包含了有帮助的命令行警告 -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- 官网提供的 axios 在线地址 -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- 引入element组件 -->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- 自己的js -->
    <script>
        var classroom = new Vue({
            el: '#classroom',
            data: {
                class_list: [],
                classroom_id: '',
                week: 4,
                section: '',
                xqj: 1,
                classroom_is_available: '',
                start: 9,
                end: 10,
                building: [],
                available: [],
                building_name: '二教',
            },
            created() {
                this.get_Thisweek();
                //获取当前星期几
                this.get_xqj();

            },
            methods: {

                async allClassroom() {
                    let that = this;
                    return new Promise((resolve, reject) => {
                        axios({
                            url: 'https://studyapi.uestc.edu.cn/api/pub/exp/school/data',
                            method: 'post',
                            data: { "type": "allclassroom", "data": [{}] },
                            timeout: 1000,
                            headers: 'Content-Type: application/json'
                        }).then(function (response) {
                            that.class_list = response.data.data;
                            resolve(that.class_list)
                        }).catch(function (error) {
                            reject();
                        })
                    })


                },
                async searchClassroom() {
                    var that = this;
                    return new Promise((resolve, reject) => {
                        axios({
                            url: 'https://studyapi.uestc.edu.cn/api/pub/exp/school/data',
                            method: 'post',
                            data: { "type": "thisweek_courseschedule", "data": [{ "room_name": that.classroom_id, "qqdjz": that.week }] },
                            timeout: 1000,
                            headers: 'Content-Type: application/json'
                        }).then(function (response) {
                            resolve(response)
                        }).catch(function (err) {
                            console.log(err);
                        })
                    })



                },


                //查询所有二教的可用教室
                async search_special_building() {
                    var that = this;
                    return new Promise(function (resolve, reject) {  //promise 创建resolve和reject函数 用于回调函数的两
                        // var i=0;
                        axios({
                            url: 'https://studyapi.uestc.edu.cn/api/pub/exp/school/data',
                            method: 'post',
                            data: { "type": "allclassroom", "data": [{}] },
                            // timeout: 1000,
                            headers: 'Content-Type: application/json',
                            async: false,
                        }).then(function (response) {

                            for (var k = 0; k < that.class_list.length; k++) {
                                if (that.class_list[k].building == that.building_name) {
                                    that.building.push(that.class_list[k]);
                                }
                            }//查找需要查找的所有教室列表并且存入building数组中
                            // console.log(that.building[0]);
                            // that.$options.methods.find_available_classroom();

                            console.log(that.building);
                            resolve(that.building)

                        }
                        ).catch(function (err) {
                            console.log(err);
                        }
                        )
                    })
                },



                async find_available_classroom() {
                    this.available = [];
                    await this.allClassroom();
                    await this.search_special_building();
                    var that = this;
                    for (i = 0; i < that.building.length; i++) {
                        //使得axio调用后再执行for
                        var that = this;
                        var tmp_room_name = that.building[i].building + that.building[i].room_name;
                        // console.log(that.building[0]);
                        // console.log(tmp_room_name);
                        await axios({
                            url: 'https://studyapi.uestc.edu.cn/api/pub/exp/school/data',
                            method: 'post',
                            data: { "type": "thisweek_courseschedule", "data": [{ "room_name": that.building[i].building + that.building[i].room_name, "qqdjz": that.week }] },

                            // timeout: 1000,
                            headers: 'Content-Type: application/json',
                            saync: false,
                        }).then(function (response) {
                            console.log(response.data.data);

                            var is_avail = true;

                            for (var j = 0; j < response.data.data.length; j++) {
                                // console.log(response.data.data[j].ksjc);
                                // console.log(that.end);
                                // console.log(response.data.data[j].ksjc >= that.end || response.data.data[j].jsjc <= that.start);
                                let [s, e] = response.data.data[j].kksd.split('-').map(Number);
                                if (response.data.data[j].xqj == that.xqj && !(response.data.data[j].ksjc >= that.end || response.data.data[j].jsjc <= that.start) && that.week >= s && week <= e) {
                                    is_avail = false;

                                }

                                else {
                                    continue;
                                }

                            }
                            if (is_avail) {
                                that.available.push(tmp_room_name);
                                console.log(tmp_room_name);
                            }





                        }).catch(function (err) {
                            console.log(err);
                        })

                    }//将所有教室名字存入available数组中
                },

                // 获取第几周
                get_Thisweek: function () {
                    var that = this;
                    axios({
                        url: 'https://studyapi.uestc.edu.cn/ckd/getWeek',
                        method: 'get',
                        timeout: 1000,

                    }).then(function (response) {
                        that.week = response.data;
                        console.log(that.week);
                    }).catch(function (error) {
                        console.log(error);
                    })

                },
                // 获取星期几
                get_xqj() {
                    //用js获取星期几
                    var now = new Date();
                    var day = now.getDay();
                    var weeks = new Array("7", "1", "2", "3", "4", "5", "6");
                    var week = weeks[day];
                    this.xqj = parseInt(week);

                }




            },

        })
    </script>


</body>

</html>